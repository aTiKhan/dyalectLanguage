
func iteratorLiteralTest1() {
    var seq = yields { 1,2,3 }
    assert([1,2,3], seq.toArray())
}

func iteratorLiteralTest2() {
    var x = 2
    var y = 3
    var seq = yields { x + y }
    x -= 1
    y *= y
    assert(10, seq.first())
}

func iteratorLiteralTest3() {
    var xs = yields { 1, 2, 3, 4, 5 }
    assert(5, xs.len())
}

func iteratorLiteralTest4() {
    var xs = yields { 1, 2, 3, 4, 5 }
    assert(5, xs.len())
    assert(5, xs.len())
    xs.first()
    assert(5, xs.len())
    xs.last()
    assert(5, xs.len())
}

func iteratorLiteralTest5() {
    var str = String.concat(values: yields {
        22 + 1.25,
        "Hello, world!",
        true
    })
    assert("23.25Hello, world!true", str)
}

func iteratorTest1() {
    func foo(token) {
        yield 1
        yield 3
        yield 44.2
        if token {
            yield break
        }
        yield 68.6
    }
    var it = foo(false)
    var res = it.element(at: 0) + it.element(at: 1) +
        it.element(at: 2) + it.element(at: 3)
    assert(116.8, res)
}

func iteratorTest2() {
    var arr = [1,2,3,4,5,6,7,8]
    func sum(arr) {
        var acc = 0
        for x in arr {
            acc += x
        }
        acc
    }
    var res = sum(arr)
    assert(36, res)
}

func iteratorTest3() {
    var arr = [1,2,3,4,5,6,7,8]
    func filter(arr, pred) {
        for x in arr {
            if pred(x) {
                yield x
            }
        }
    }
    func sum(arr) {
        var acc = 0
        for x in arr {
            acc += x
        }
        acc
    }
    var filtered = filter(arr, x => x % 2 == 0)
    var res = sum(filtered)
    assert(20, res)
}

func iteratorTest4() {
    func reverse(arr) {
        var newArr = []
        newArr.addRange(arr) //hack
        var len = newArr.len()
        var counter = 1
        for x in arr {
            newArr[len - counter] = x
            counter += 1
        }
        newArr
    }
    func makeString(arr) {
        var str = ""
        for x in arr {
            str += x
        }
        str
    }
    let arr = reverse("Hello")
    var res = makeString(arr)
    assert("olleH", res)
}

func iteratorTest5() {
    func filter(arr, pred) {
        for x in arr {
            if pred(x) {
                yield x
            }
        }
    }
    func toArray(seq) {
        var arr = []
        for x in seq {
            arr.add(x)
        }
        arr
    }
    let arr = toArray( filter("hello", x => x == 'l') )
    var res = arr[0] + arr[1]
    assert("ll", res)
}

func iteratorTest6() {
    var arr = [1,3,5,8]
    var x =
        for x in arr {
            if x % 2 == 0 {
                break x
            }
        }
    assert(8, x)
}

func iteratorTest7() {
    func Integer.iter() {
        var i = 0
        if this < 0 {
            while i > this {
                yield i
                i -= 1
            }
        } else {
            while i < this {
                yield i
                i += 1
            }
        }
    }

    var res = 5.iter().toArray()
    Integer.__deleteMember("iter")
    assert([0,1,2,3,4], res)
}

func iteratorTest8() {
    var xs = 1..10
    assert(10, xs.len())
    for x in xs {
        if x > 3 {
            break
        }
    }
    xs.first()
    assert(10, xs.len())
}

func iteratorTest9() {
    var xs = 1..5
    var ys = 6..10
    var res = Iterator.concat(xs, ys)
    assert([1..10], res.toArray())
}

func iteratorTest10() {
    var xs = 1..5
    var ys = 6..10
    var res = Iterator(xs, ys)
    assert([1..10], res.toArray())
}

func iteratorTest11() { //#289
    var xs = 1..5
    var res = Iterator(xs)
    assert((1,2,3,4,5), res.toTuple())
}

func yieldManyTest1() {
    func bar() {
        yield 4
        yield 5
        yield 6
    }
    func foo() {
        yield 1
        yield 2
        yield 3
        yield many bar()
    }
    var seq = foo().toArray()
    assert([1,2,3,4,5,6],seq)
}

func yieldManyTest2() {
    func bar() {
        yield 31
        yield 32
        yield 33
    }
    func foo() {
        yield 1
        yield 2
        yield 3
        yield many bar()
        yield 4
        yield 5
    }
    var seq = foo().toArray()
    assert([1,2,3,31,32,33,4,5],seq)
}

func yieldManyTest3() { //#96
    func zoo() {
        yield 31
        yield 32
    }
    func bar() {
        yield 21
        yield 22
    }
    func foo() {
        yield 1
        yield 2
        yield many bar()
        yield 3
        yield many zoo()
        yield 4
    }
    var seq = foo().toArray()
    assert([1,2,21,22,3,31,32,4],seq)
}

func yieldManyTest4() { //#96
    func zoo() {
        yield 31
        yield 32
    }
    func bar() {
        yield 21
        yield 22
    }
    func foo() {
        yield 1
        yield 2
        yield many bar()
        yield 3
        yield many zoo()
        yield 4
        yield many bar()
        yield many zoo()
    }
    var seq = foo().toArray()
    assert([1,2,21,22,3,31,32,4,21,22,31,32],seq)
}

func yieldManyTest5() { //#96
    func bar() {
        yield 2
        yield 3
    }
    func foo() {
        yield 1
        yield bar()
    }
    var arr = foo().toArray()
    assert(1, arr[0])
    assert([2,3], arr[1].toArray())
}

func takeTest1() {
    var seq = yields { 1,2,3,4,5 }
    var xs = seq.take(3).toArray()
    assert([1,2,3], xs)
}

func skipTest1() {
    var seq = yields { 1,2,3,4,5 }
    var xs = seq.skip(3).toArray()
    assert([4,5], xs)
}

func firstTest1() {
    var seq = yields { 1,2,3,4,5 }
    assert(1, seq.first())
}

func lastTest1() {
    var seq = yields { 1,2,3,4,5 }
    assert(5, seq.last())
}

func tryCatchBug() { //bug #365
    var val = 0
    func iter() {
        try {
            yield 1
            throw "oops"
            yield 2
        } catch e {
            val = 42
        }
    }
    for _ in iter() { }
    assert(42, val)
}

func yieldBreakTest1() { // #399
    func seq() {
    var x = 100
    while x > 0 {
            yield x
            x -= 1
            if x == 87 {
                yield break
            }
        }
    }
    var xs = []
    for x in seq() {
        xs.add(x)
    }
    assert([100, 99, 98, 97, 96, 95, 94, 93, 92, 91, 90, 89, 88], xs)
}

func sliceTest1() { // #409
    var seq = 1..10
    var xs = seq[5..].toArray()
    assert([6, 7, 8, 9, 10], xs)
}

func rangeInIterator() {
    let seq = yields { 1..5 }
    assert([1,2,3,4,5], seq.toArray())
}

func iteratorStateBug() {
    let seq = yields { 1,2,3,4,5 }
    assert(2, seq[1])
    assert(2, seq[1])
    assert([1,2,3], seq.take(3).toArray())
    assert([1,2,3], seq.take(3).toArray())
}

func elementAtAndIndexer() {
    let seq = yields { 1..10 }
    assert(2, seq.element(1))
    assert(2, seq.element(at: 1))
    assert(10, seq.element(9))
    assert(10, seq.element(at: 9))
    assert(9, seq.element(-1))
    assert(2, seq[1])
    assert(2, seq[1])
    assert(10, seq[9])
    assert(10, seq[9])
}

func emptyTest() {
    let seq = Iterator.empty()
    assert(true, seq is Iterator)
    assert(0, seq.len())
    for x in seq {
        assert(true, false)
    }
}

func repeatTest() {
    func defaultValue() {
        var i = 0
        while true {
            yield i
            i += 1
        }
    }
    assert([0,0,0], Iterator.repeat(0).take(3).toArray())
    assert([3,3,3], Iterator.repeat(()=>3).take(3).toArray())
    assert([0,1,2,3,4], Iterator.repeat(defaultValue()).take(5).toArray())
}
